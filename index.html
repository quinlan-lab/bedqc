<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="author" content="Joe Brown" />
    <title>bedqc</title>

    <link href="https://fonts.googleapis.com/css2?family=Fraunces&display=swap" rel="stylesheet" />
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.plot.ly/plotly-2.2.0.min.js"></script>
    <script src="https://cdn.biowasm.com/v2/aioli/latest/aioli.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.1/papaparse.min.js"></script>

    <style>
        body {
            height: 100vh;
            margin: 0px;
            padding: 0px;
        }

        .brand {
            font-family: "Fraunces", serif;
            font-size: 2.2rem;
            letter-spacing: -0.05em;
            color: #d91e30 !important;
        }

        .form-control-lg {
            font-size: 1rem;
        }

        .info-card {
            min-height: 165px;
        }

        .plot-card {
            min-height: 362px;
        }

        .tab-content>.tab-pane:not(.active),
        .pill-content>.pill-pane:not(.active) {
            display: block;
            height: 0;
            overflow-y: hidden;
        }
    </style>
</head>

<main class="d-flex flex-row">

    <div class="sticky-top h-100">

        <nav class="d-flex flex-column flex-shrink-0 p-2 vh-100" style="width: 300px;" id="nav-pane">
            <a class="navbar-brand brand d-flex align-items-center mb-md-0 me-md-auto text-decoration-none"
                href="https://github.com/quinlan-lab/bedqc">.bed qc</a>

            <div class="bg-light py-3 px-2 border">
                <div class="">
                    <label for="genome-select" class="form-label">Genome</label>
                    <select class="form-select form-select-sm" id="genome-select">
                        <option selected>hg38</option>
                        <option>hg19</option>
                    </select>
                </div>
                <div class="user-upload pt-3">
                    <!-- <label for="file-upload" class="form-label">Upload</label> -->
                    <input class="form-control form-control-lg" type="file" id="file-upload">
                </div>
            </div>

            <div class="p-2">
                <label class="form-label">Intersect</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="intersect-gap">
                    <label class="form-check-label" for="intersect-gap">
                        gaps
                    </label>
                </div>
            </div>

        </nav>
    </div>

    <div class="d-flex flex-column flex-fill p-3 pe-5">

        <ul class="nav nav-tabs" id="main-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="help-tab" data-bs-toggle="tab" data-bs-target="#help-pane"
                    type="button" role="tab">Help</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link disabled" id="results-tab" data-bs-toggle="tab" data-bs-target="#results-pane"
                    type="button" role="tab">Results</button>
            </li>
        </ul>

        <div class="tab-content pt-3">
            <div class="tab-pane fade show active" id="help-pane" role="tabpanel">
                <h2 class="pb-2">Using bed qc</h2>
                <div class="row pb-4">
                    <div class="col-4">
                        <!-- <div class="card info-card"> -->
                        <div class="card-body">
                            <h5 class="card-title">1. Select genome</h5>
                            <p class="card-text">Choose the likely genome build of your BED file. This option can be
                                changed throughout the analysis.
                            </p>
                        </div>
                        <!-- </div> -->
                    </div>
                    <div class="col-4">
                        <!-- <div class="card info-card"> -->
                        <div class="card-body">
                            <h5 class="card-title">2. Select file</h5>
                            <p class="card-text">Click <code>Browse...</code> or drag-and-drop your BED file to load.
                            </p>
                        </div>
                        <!-- </div> -->
                    </div>
                    <div class="col-4">
                        <!-- <div class="card info-card"> -->
                        <div class="card-body">
                            <h5 class="card-title">3. Select intersection(s)</h5>
                            <p class="card-text">Choose additional overlap options to determine quality and genome build
                                of your intervals.
                            </p>
                        </div>
                        <!-- </div> -->
                    </div>
                </div>
                <h2 class="pb-2">Interpreting plots</h2>
                <h4>Interval density</h4>
                <div class="row pb-4">
                    <div class="col-6">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-success">Normal</h6>
                            <div class="card-img-top" id="interval-density-normal"></div>
                            <p class="card-text pt-2">Based on the known chromosome length and total interval count, the
                                intervals are spread evenly among the chromosomes.
                            </p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-warning">Potential issue</h6>
                            <div class="card-img-top" id="interval-density-issue"></div>
                            <p class="card-text">Unequal distribution among chromosomes could mean
                                a filter has been applied unevenly or possible file truncation.
                            </p>
                        </div>
                    </div>
                </div>
                <h4>Gap intersect</h4>
                <div class="row pb-3">
                    <div class="col-6">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-success">Normal</h6>
                            <div class="card-img-top" id="gap-intersect-normal"></div>
                            <p class="card-text pt-2">Our intervals (in this case) do not overlap the centromeres
                                suggesting the selected genome build is <span class="fw-bold fst-italic">not
                                    incorrect</span>.
                            </p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-warning">Potential issue</h6>
                            <div class="card-img-top" id="gap-intersect-issue"></div>
                            <p class="card-text">In most cases, when we overlap our meaningful regions
                                with known gaps we anticipate no centromere overlap.
                            </p>
                        </div>
                    </div>
                </div>
            </div>


            <div class="tab-pane fade" id="results-pane" role="tabpanel">
                <div id="summary-plot-wrapper">
                    <div class="row" id="metrics-row">
                        <div class="col-12">
                            <h3>Summary: <span id="summary-filename"></span></h3>
                        </div>
                    </div>
                    <div class="row pt-1">
                        <div class="col-6">
                            <table class="table table-borderless table-small">
                                <tbody id="metadata-table">
                                    <tr>
                                        <td>Interval count</td>
                                        <td id="summary-interval-count"></td>
                                    </tr>
                                    <tr>
                                        <td>Total base pairs</td>
                                        <td id="summary-total-bp"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script type="module">

    const qc_data = [];
    const plot_y = 375;
    const plot_config = {
        displaylogo: false,
        toImageButtonOptions: {
            format: 'svg', // one of png, svg, jpeg, webp
            filename: 'bedqc',
            height: 600,
            width: 1200,
            scale: 1 // Multiply title/legend/axis/canvas sizes by this factor
        },
        responsive: true,
    }
    const aesthetics = {
        palette: ["#4e79a7", "#f28e2c", "#e15759", "#76b7b2", "#59a14f", "#edc949", "#af7aa1", "#ff9da7", "#9c755f", "#bab0ab"],
        tickfont: {
            family: "Courier New, monospace",
            size: 16,
            color: "#000",
        },
        labelfont: {
            family: "Raleway, sans-serif",
            size: 12,
        }
    }

    const build_example_plot = ({ x, o, e, divid, ytitle }) => {
        let traces = [{ x: x, y: o, type: "bar", marker: { color: aesthetics.palette[0], line: { color: 'black', width: 1 }, }, name: "Observed" }];
        if (e.length > 0) {
            traces.push({ x: x, y: e, type: "scatter", name: "Expected", mode: "markers", marker: { size: 12, symbol: "circle", color: "#f28e2c", line: { color: 'rgb(255,255,255)', width: 1 }, } })
        }
        let layout = { height: 200, font: aesthetics.labelfont, padding: { t: 0, r: 0, b: 0 }, margin: { t: 0, r: 0, b: 0 }, xaxis: { automargin: true, type: "category", }, yaxis: { title: ytitle, automargin: true, }, legend: { font: { size: 12 } } };
        Plotly.newPlot(divid, traces, layout, { staticPlot: true, responsive: true });
    }

    // build the example page during page load
    build_example_plot({
        x: ["chr1", "chr2", "chr3"],
        o: [0.075, 0.079, 0.06],
        e: [0.08, 0.07, 0.06],
        divid: "interval-density-normal",
        ytitle: "Density"
    })
    build_example_plot({
        x: ["chr1", "chr2", "chr3"],
        o: [0.075, 0.13, 0.025],
        e: [0.08, 0.07, 0.06],
        divid: "interval-density-issue",
        ytitle: "Density"
    })
    build_example_plot({
        x: ["chr1", "chr2", "chr3"],
        o: [0, 0, 0],
        e: [],
        divid: "gap-intersect-normal",
        ytitle: "Count"
    })
    build_example_plot({
        x: ["chr1", "chr2", "chr3"],
        o: [50, 57, 22],
        e: [],
        divid: "gap-intersect-issue",
        ytitle: "Count"
    })

    const add_plot_div = (track, title) => {
        let d = document.getElementById("summary-plot-wrapper")

        let exists = document.getElementById(`${track}-row`);
        if (!(exists)) {
            d.insertAdjacentHTML(
                'beforeend',
                `<div class="row" id="${track}-row">
                    <div class="col-12">
                        <h3>${title}</h3>
                    </div>
                </div>
                <div class="row pt-1" id="${track}-plot-row">
                    <div class="col-12">
                        <div id="${track}-plot"></div>
                    </div>
                </div>`
            )
        }
        return Promise.resolve()
    }

    const add_table_row = ({ title, value }) => {
        let divid = title.replace(" ", "-")
        let d = document.getElementById("metadata-table")
        let exists = document.getElementById(divid)
        if (!(exists)) {
            d.insertAdjacentHTML(
                "beforeend",
                `<tr>
                    <td>${title}</td>
                    <td id="${divid}">${value}</td>
                </tr>`
            )
        } else {
            $(`#${divid}`).html(value)
        }
    }

    let CLI = await new Aioli("bedtools/2.29.2");
    const output = await CLI.exec("bedtools --version");
    console.log(`Loaded ${output}`);

    const strip_prefix = (str) => {
        if (str.startsWith("chr")) {
            return str.slice(3)
        }
        return str
    }

    // arr.sort(function (a, b) {
    //     let _a = strip_prefix(a)
    //     let _b = strip_prefix(b)
    //     console.log(_a, _b)
    //     return _a - _b || _a > _b
    // });

    let chromosome_lengths = {};
    let prefix = true

    const to_title = (str) => {
        return str.replace(
            /\w\S*/g,
            (txt) => {
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
            }
        )
    }

    const cli = async (file, genome, track, chromosomes, file_str) => {
        // await CLI.ls(".")
        await CLI.fs.writeFile("b.bed", file_str);
        // sort UCSC query
        let o = await CLI.exec("bedtools sort -i b.bed")
        // overwrite track with sorted track
        await CLI.fs.writeFile("b.bed", o);
        // mount user upload
        await CLI.mount($('#file-upload').prop('files')[0])
        // intersect user upload and UCSC track
        o = await CLI.exec(`bedtools intersect -a ${file.name} -b b.bed`)

        // rows
        o = o.split("\n").map(p => p.split("\t"))

        let chr_count = {}
        o.forEach(row => {
            chr_count[row[0]] = (chr_count[row[0]] || 0) + 1;
        })

        // append a div...
        add_plot_div(track, `${to_title(track)} intersect count`)
        build_bar_plot(
            chromosomes,
            chromosomes.map(chr => chr_count[chr]),
            "Chromosome",
            "Overlap count",
            `${track}-plot`
        )
    }

    const bedtools_intersect = async (file, genome, track, chromosomes, prefix) => {
        let ucsc_str = ""
        jQuery.getJSON(`https://api.genome.ucsc.edu/getData/track?genome=${genome};track=${track}`, (track_data) => {
            let selection = track_data[track]
            chromosomes.forEach(chr => {
                // chromosomes come from user file; check exists in API track
                if (chr in selection) {
                    selection[chr].forEach(idx => {
                        if (!(prefix)) {
                            // strip chr prefix from UCSC result
                            console.log("stripping chr prefix from UCSC results")
                            ucsc_str += `${idx.chrom.substring(3)}\t${idx.chromStart}\t${idx.chromEnd}\n`
                        } else {
                            ucsc_str += `${idx.chrom}\t${idx.chromStart}\t${idx.chromEnd}\n`
                        }
                    })
                }
            });
        }).then(() => {
            cli(file, genome, track, chromosomes, ucsc_str)
        })
    }

    const checkbox_change = (event) => {
        if (event.target.checked == false) {
            // remove the div of the unchecked intersection
            // intersect-gap and need to remove gap-row, gap-plot-row
            let pfx = event.target.id.split("-")[1]
            document.getElementById(`${pfx}-row`).remove()
            document.getElementById(`${pfx}-plot-row`).remove()
        } else {
            let file = $('#file-upload').prop('files')[0]
            let genome = $('#genome-select').val()
            if ($("#intersect-gap").prop("checked") == true) {
                bedtools_intersect(file, genome, "gap", m.chromosomes, m.chr_prefix)
            }
            // additional checkboxes
        }
    }

    const handle_checkboxes = ({ file, genome, chroms, chr_prefix }) => {
        if ($("#intersect-gap").prop("checked") == true) {
            bedtools_intersect(file, genome, "gap", chroms, chr_prefix)
        }
        // additional checkboxes
    }

    let m = {
        'interval_count': 0,
        'interval_length_total': 0,
        'interval_lengths': [],
        'filtered_intervals': 0,
        'zero_length_intervals': 0,
        'extends_beyond_chr': 0,
        'chr_prefix': true,
        'chromosomes': []
    }

    const onChange = (event) => {
        document.getElementById("intersect-gap").addEventListener('change', checkbox_change);

        let genome = $('#genome-select').val()
        let chromosome_lengths;
        jQuery.getJSON(`https://api.genome.ucsc.edu/list/chromosomes?genome=${genome}`, (d) => {
            chromosome_lengths = d.chromosomes
            // adds non-chr prefixed chroms in addition to chr prefixed result
            Object.keys(chromosome_lengths).map(k => chromosome_lengths[k.substring(3)] = chromosome_lengths[k])
        }).then(() => {
            let interval_length = {}
            let interval_count = {}
            // new upload
            m = {
                'interval_count': 0,
                'interval_count_filtered': 0,
                'interval_length_total': 0,
                'interval_lengths': [],
                'filtered_intervals': 0,
                'zero_length_intervals': 0,
                'extends_beyond_chr': 0,
                'chr_prefix': true,
                'chromosomes': []
            }
            if ($('#file-upload').prop('files')[0]) {
                Papa.parse($('#file-upload').prop('files')[0], {
                    delimiter: "\t",
                    skipEmptyLines: true,
                    header: false,
                    step: (results, parser) => {
                        m.interval_count += 1;
                        // check number of toks testing the delimiter
                        // likely going to need lengths in the future
                        let chr = results.data[0];
                        // skip unhelpful chromosomes
                        if (chr.match(/fix|random|alt|Un|hap/g) === null) {
                            m.interval_count_filtered += 1;
                            if (results.data.length < 3) {
                                // invalid format or separator
                                // raise format error
                                results.data = []
                                console.log("invalid format (chrom, start, stop) or separator ('\\t')")
                                return
                            }

                            // check for 'chr' prefix
                            if (!(chr.startsWith('chr'))) {
                                m.chr_prefix = false
                                // will need to check if some have chr and some do not
                            }

                            // set the chromosome order by appearance in bed file
                            if (!(chr in interval_length)) {
                                m.chromosomes.push(chr);
                            }

                            // malformatted entry; 0-based start, 1-based end
                            let current_length = results.data[2] - results.data[1]
                            if (current_length == 0) {
                                m.zero_length_intervals += 1
                            }

                            m.interval_length_total += current_length

                            // check if end extends beyond chrom end
                            // this could also be a plot

                            m.interval_lengths.push(current_length)
                            interval_length[chr] = (interval_length[chr] || 0) + current_length;
                            interval_count[chr] = (interval_count[chr] || 0) + 1;
                        }
                        else {
                            m.filtered_intervals += 1
                        }
                    },
                    complete: (results, file) => {

                        var element = document.getElementById("results-tab");
                        element.classList.remove("disabled");

                        var someTabTriggerEl = document.querySelector('#results-tab')
                        var tab = new bootstrap.Tab(someTabTriggerEl)
                        tab.show()

                        // $("#file-upload-primary-wrapper").prop("hidden", true);
                        // $("#summary-plot-wrapper").prop("hidden", false);
                        // $(".user-upload").prop("hidden", false);
                        // $(".howto").prop("hidden", true);

                        $("#summary-filename").html(file.name)
                        $("#summary-interval-count").html(m.interval_count.toLocaleString())
                        $("#summary-total-bp").html(m.interval_length_total.toLocaleString())
                        if (m.filtered_intervals > 0) {
                            add_table_row({
                                title: "Filtered intervals",
                                value: m.filtered_intervals.toLocaleString()
                            })
                        }
                        if (m.zero_length_intervals > 0) {
                            add_table_row({
                                title: "0-length intervals",
                                value: m.zero_length_intervals.toLocaleString()
                            })
                        }

                        add_plot_div('interval-density', 'Interval density')
                        // length corrected for only displayed chromosomes
                        let genome_length = 0
                        m.chromosomes.map(x => genome_length += chromosome_lengths[x])

                        build_bar_plot(
                            m.chromosomes,
                            m.chromosomes.map(x => interval_count[x] / m.interval_count_filtered),
                            "Chromosome",
                            "Density",
                            "interval-density-plot",
                            {
                                x: m.chromosomes,
                                y: m.chromosomes.map(x => (chromosome_lengths[x] / genome_length)),
                                type: "scatter",
                                name: "Expected",
                                mode: "markers",
                                marker: {
                                    size: 12, symbol: "circle", color: "#f28e2c", line: {
                                        color: 'rgb(255,255,255)',
                                        width: 1
                                    },
                                }
                            }
                        );
                        add_plot_div('interval-size-dist', 'Interval size distribution').then(() => {
                            var trace = {
                                x: m.interval_lengths,
                                type: 'histogram',
                                marker: {
                                    color: aesthetics.palette[0],
                                },
                            };
                            let layout = {
                                height: plot_y,
                                font: aesthetics.labelfont,
                                padding: {
                                    t: 0,
                                    r: 0,
                                },
                                margin: {
                                    t: 0,
                                    r: 0,
                                },
                                xaxis: {
                                    title: "Interval length",
                                    automargin: true,
                                },
                                yaxis: {
                                    title: "Count",
                                    automargin: true,
                                },
                                legend: {
                                    font: {
                                        size: 16
                                    }
                                }
                            };
                            Plotly.newPlot('interval-size-dist-plot', [trace], layout, plot_config)
                        })

                        // handle checkboxes
                        handle_checkboxes({
                            file: file,
                            genome: genome,
                            chroms: m.chromosomes,
                            chr_prefix: m.chr_prefix
                        })
                    }
                })
            }
        })
    }

    // const mean = (data) => {
    //     let result = 0;
    //     let n = 0;
    //     for (let i = 0; i < data.length; i++) {
    //         let d = data[i];
    //         if (d >= 0) {
    //             n += 1;
    //             result += d;
    //         }
    //     }
    //     return result / n;
    // };

    const build_bar_plot = (chrs, o, x_title, y_title, div, trace = false) => {
        let traces = [
            {
                x: chrs,
                y: o,
                type: "bar",
                marker: {
                    color: aesthetics.palette[0],
                    line: {
                        color: 'black',
                        width: 1
                    },
                },
                name: "Observed"
            }
        ];

        if (trace) {
            traces.push(trace)
        }
        // console.log(traces)

        let layout = {
            height: plot_y,
            font: aesthetics.labelfont,
            padding: {
                t: 0,
                r: 0,
            },
            margin: {
                t: 0,
                r: 0,
            },
            xaxis: {
                title: x_title,
                automargin: true,
                type: "category",
            },
            yaxis: {
                title: y_title,
                automargin: true,
            },
            legend: {
                font: {
                    size: 16
                }
            }
        };

        return Plotly.newPlot(div, traces, layout, plot_config);
    };

    $(document).ready(function () {
        document.getElementById("file-upload").addEventListener('change', onChange);
        document.getElementById("genome-select").addEventListener('change', onChange);
    });
</script>

</html>
